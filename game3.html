<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platformer</title>
    <script type="module">
        import kaboom from "https://unpkg.com/kaboom@3000.0.1/dist/kaboom.mjs";
        kaboom();

        const SPEED = 200;
        const JUMP_FORCE = 400;
        const FALL_DEATH = 2400;

        scene("game", ({ levelId, coins } = { levelId: 0, coins: 0 }) => {

            // player object
            const player = add([
                rect(20, 40),
                pos(80, 100),
                area(),
                color(255, 0, 0),
                body(),
                "player",
            ]);

            // ground object
            const ground = add([
                rect(width(), 20),
                pos(0, height() - 20),
                area(),
                color(0, 255, 0),
                solid(),
                "ground",
            ]);

            // platform object
            const platform = add([
                rect(200, 20),
                pos(150, height() - 150),
                area(),
                color(0, 0, 255),
                solid(),
                "platform",
            ]);

            // action every frame
            onUpdate(() => {
                if (isKeyDown("a")) {
                    player.move(-SPEED, 0);
                }
                if (isKeyDown("d")) {
                    player.move(SPEED, 0);
                }
                if (isKeyDown("space") && player.isGrounded()) {
                    player.jump(JUMP_FORCE);
                }
                if (player.pos.y >= FALL_DEATH) {
                    go("lose");
                }
            });

            player.onCollide("ground", () => {
                player.isGrounded(true);
            });

            player.onCollide("platform", () => {
                player.isGrounded(true);
            });

            player.onExit("ground", () => {
                player.isGrounded(false);
            });

            player.onExit("platform", () => {
                player.isGrounded(false);
            });

            // collision with danger
            player.onCollide("danger", () => {
                go("lose");
            });

            // collision with portal
            player.onCollide("portal", () => {
                if (levelId + 1 < LEVELS.length) {
                    go("game", {
                        levelId: levelId + 1,
                        coins: coins,
                    });
                } else {
                    go("win");
                }
            });

            // basic movement controls
            onKeyPress("space", () => {
                if (player.isGrounded()) {
                    player.jump(JUMP_FORCE);
                }
            });

            onKeyDown("left", () => {
                player.move(-SPEED, 0);
            });

            onKeyDown("right", () => {
                player.move(SPEED, 0);
            });

            onKeyPress("down", () => {
                player.weight = 3;
            });

            onKeyRelease("down", () => {
                player.weight = 1;
            });

            const coinsLabel = add([
                text(coins),
                pos(24, 24),
                fixed(),
            ]);

            onKeyPress("f", () => {
                setFullscreen(!isFullscreen());
            });
        });

        scene("lose", () => {
            add([
                text("You Lose"),
            ]);
            onKeyPress(() => go("game"));
        });

        scene("win", () => {
            add([
                text("You Win"),
            ]);
            onKeyPress(() => go("game"));
        });

        go("game");
    </script>
</head>
<body>
    <h1>Platformer</h1>
</body>
</html>
